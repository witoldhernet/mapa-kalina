<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mapa Kalina</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">

    <style>
        /* --- BAZA --- */
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; overflow: hidden; background: #e0e0e0; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #e0e0e0; }

        /* --- STYL PINEZEK --- */
        .circle-marker {
            background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid #ccc; 
            transition: transform 0.2s;
        }
        .circle-marker:hover { transform: scale(1.2); z-index: 10000 !important; cursor: pointer; }
        .circle-marker .material-symbols-rounded { font-size: 20px !important; }

        /* Styl dla działek */
        .plot-number-marker {
            background-color: #ffffff; border: 1.5px solid #FF9800; color: #333;
            border-radius: 50%; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .plot-number-marker:hover { transform: scale(1.4); z-index: 9999 !important; border-color: #EA4335; background-color: #fff; }

        /* --- WYSZUKIWARKA (POPRAWIONA STRUKTURA) --- */
        #search-container {
            position: absolute; top: 12px; left: 12px; right: 12px;
            z-index: 2000; display: flex; flex-direction: column; align-items: center;
            pointer-events: none;
        }
        
        .search-wrapper { 
            position: relative; width: 100%; max-width: 400px; 
            pointer-events: auto; 
            display: flex; flex-direction: column;
        }

        .search-card {
            background: white; width: 100%; height: 48px;
            border-radius: 24px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; padding: 0 5px;
            transition: border-radius 0.2s, box-shadow 0.2s;
            z-index: 2; /* Musi być nad listą */
            box-sizing: border-box; /* Ważne dla wyrównania */
        }
        
        /* Gdy lista otwarta - usuwamy dolne zaokrąglenie */
        .search-card.open { 
            border-bottom-left-radius: 0; 
            border-bottom-right-radius: 0; 
            border-bottom: 1px solid #eee;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }

        .icon-box { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: #5F6368; }
        #search-input { border: none; outline: none; flex-grow: 1; height: 100%; font-size: 16px; color: #202124; background: transparent; min-width: 0; }
        #search-btn { background: transparent; border: none; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: #1A73E8; }

        /* Lista podpowiedzi */
        #suggestions-list {
            list-style: none; margin: 0; padding: 0;
            background: white; width: 100%;
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            overflow: hidden; display: none;
            max-height: 60vh; overflow-y: auto;
            position: absolute; /* Pływa pod paskiem */
            top: 48px; /* Dokładnie pod paskiem */
            left: 0;
            z-index: 1;
            box-sizing: border-box; /* Ważne dla wyrównania */
        }
        
        .suggestion-item {
            padding: 12px 16px; border-top: 1px solid #f1f3f4;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            font-size: 14px; color: #202124;
        }
        .suggestion-item:hover { background-color: #f1f3f4; }
        
        /* Styl aktywnego elementu (dla klawiatury) */
        .suggestion-item.active { background-color: #e8eaed; color: #202124; }
        
        .suggestion-icon { font-size: 20px; color: #70757A; }
        .suggestion-sub { font-size: 12px; color: #70757A; margin-left: auto; }
        .suggestion-item.is-plot .suggestion-icon { color: #FF9800; font-weight: bold; }
        .suggestion-item.is-plot { font-weight: 500; }

        /* --- POPUPY --- */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        .gm-popup-body { padding: 16px 20px; text-align: left; }
        .gm-title { font-size: 18px; font-weight: 500; color: #202124; margin-bottom: 4px; }
        .gm-sub { font-size: 13px; color: #5F6368; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .gm-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: #1A73E8; color: white !important; text-decoration: none; font-size: 14px; font-weight: 500; padding: 10px 0; width: 100%; border-radius: 20px; transition: background 0.2s; }
        .gm-btn:hover { background: #1557B0; }

        /* Etykiety ulic */
        .street-popup .leaflet-popup-content-wrapper { background: rgba(255, 255, 255, 0.95); color: #333; font-size: 13px; font-weight: 600; padding: 0; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: center; }
        .street-popup .leaflet-popup-tip-container { display: none; }
        .street-label-content { padding: 6px 12px; font-family: 'Roboto', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .street-icon { font-size: 16px; color: #5F6368; }

        /* Lokalizacja */
        .fab-loc { position: absolute; bottom: 24px; right: 24px; width: 56px; height: 56px; background: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: none; z-index: 1000; cursor: pointer; color: #1A73E8; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="search-container">
        <div class="search-wrapper">
            <div class="search-card" id="search-card">
                <div class="icon-box"><span class="material-symbols-rounded">search</span></div>
                <input type="text" id="search-input" placeholder="Szukaj (np. 3, 18, Boisko)..." autocomplete="off">
                <button id="search-btn" onclick="clearSearch()" style="display:none;"><span class="material-symbols-rounded">close</span></button>
            </div>
            <ul id="suggestions-list"></ul>
        </div>
    </div>

    <button class="fab-loc" id="locate-me">
        <span class="material-symbols-rounded" style="font-size:28px;">my_location</span>
    </button>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. INICJALIZACJA ---
        const map = L.map('map', { zoomControl: false }).setView([52.551, 17.715], 17);
        const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{ maxZoom: 21 });
        googleSat.addTo(map);

        // --- 2. GENERATORY IKON ---
        function createCirclePin(iconName, colorHex) {
            return L.divIcon({
                className: 'circle-marker-container', 
                html: `<div class="circle-marker" style="border-color: ${colorHex}; width: 34px; height: 34px;"><span class="material-symbols-rounded" style="color: ${colorHex};">${iconName}</span></div>`,
                iconSize: [34, 34], iconAnchor: [17, 17], popupAnchor: [0, -18]
            });
        }
        function createPlotNumberIcon(number) {
            return L.divIcon({
                className: 'plot-wrapper',
                html: `<div class="plot-number-marker">${number}</div>`,
                iconSize: [22, 22], iconAnchor: [11, 11], popupAnchor: [0, -12]
            });
        }

        // --- 3. STYLIZACJA I DANE ---
        function getStyleInfo(type, data, rawName) {
            const name = String(rawName);
            const nameLower = name.toLowerCase();
            const dataType = data?.type || '';

            if (type === 'plot') return { icon: createPlotNumberIcon(name), typeLabel: 'Działka rekreacyjna', iconName: 'grid_view', isPlot: true };

            let icon = 'location_on'; let color = '#EA4335'; let typeLabel = 'Miejsce';
            
            if (dataType === 'sport' || nameLower.includes('boisko')) {
                typeLabel = 'Sport';
                if (nameLower.includes('kosz')) { icon = 'sports_basketball'; color = '#FF6D00'; }
                else if (nameLower.includes('nożn')) { icon = 'sports_soccer'; color = '#2E7D32'; }
                else if (nameLower.includes('siatk')) { icon = 'sports_volleyball'; color = '#9C27B0'; }
                else if (nameLower.includes('tenis')) { icon = 'sports_tennis'; color = '#AFB42B'; }
                else { icon = 'sports_soccer'; color = '#2E7D32'; }
            }
            else if (dataType === 'relaks') { icon = 'self_improvement'; color = '#F57C00'; typeLabel = 'Relaks'; }
            else if (dataType === 'park' || nameLower.includes('park')) { icon = 'park'; color = '#2E7D32'; typeLabel = 'Park'; }
            else if (dataType === 'sklep' || nameLower.includes('sklep')) { icon = 'shopping_cart'; color = '#0277BD'; typeLabel = 'Sklep'; }
            else if (dataType === 'bar' || nameLower.includes('bar')) { icon = 'sports_bar'; color = '#FBC02D'; typeLabel = 'Gastronomia'; }
            else if (dataType === 'parking' || nameLower.includes('parking')) { icon = 'local_parking'; color = '#1565C0'; typeLabel = 'Parking'; }
            else if (dataType === 'furtka') { icon = 'door_front'; color = '#455A64'; typeLabel = 'Wejście'; }
            else if (dataType === 'brama' || nameLower.includes('brama')) { icon = 'gate'; color = '#C62828'; typeLabel = 'Brama'; }
            else if (dataType === 'szlaban' || nameLower.includes('szlaban')) { icon = 'no_crash'; color = '#C62828'; typeLabel = 'Szlaban'; }
            else if (dataType === 'info') { icon = 'info'; color = '#0277BD'; typeLabel = 'Informacja'; }
            else if (dataType === 'woda' || nameLower.includes('wod')) { icon = 'water_drop'; color = '#0288D1'; typeLabel = 'Woda'; }
            else if (dataType === 'biuro') { icon = 'apartment'; color = '#546E7A'; typeLabel = 'Biuro'; }
            else if (nameLower.includes('toalet') || nameLower.includes('wc')) { icon = 'wc'; color = '#00695C'; typeLabel = 'Toaleta'; }

            return { icon: createCirclePin(icon, color), typeLabel: typeLabel, iconName: icon, isPlot: false };
        }

        const markersGroup = L.layerGroup().addTo(map);
        let allMarkers = [];

        async function loadData() {
            try {
                const res = await fetch('kalina_backup.json');
                const data = await res.json();

                // Ścieżki
                if(data.paths) {
                    data.paths.forEach(p => {
                        const points = p.points.map(pt => [parseFloat(pt[0]), parseFloat(pt[1])]);
                        const polyline = L.polyline(points, { 
                            color: p.type === 'auto' ? '#ffffff' : '#FFC107', 
                            weight: p.type === 'auto' ? 5 : 3, 
                            opacity: 0.85 
                        }).addTo(map);

                        const streetPopupContent = `
                            <div class="street-label-content">
                                <span class="material-symbols-rounded street-icon">signpost</span>
                                ${p.name}
                            </div>`;
                        polyline.bindPopup(streetPopupContent, { className: 'street-popup', closeButton: false, autoPan: false });

                        allMarkers.push({ name: p.name, layer: polyline, typeLabel: 'Aleja', iconName: 'signpost', isPath: true, isPlot: false });
                    });
                }

                // Markery
                if(data.markers) {
                    data.markers.forEach(m => {
                        const safeName = m.name ? String(m.name) : "?";
                        const styleInfo = getStyleInfo(m.type, m.iconData, safeName);
                        const marker = L.marker([m.lat, m.lng], { icon: styleInfo.icon });

                        const content = `
                            <div class="gm-popup-body">
                                <div class="gm-title">${safeName}</div>
                                <div class="gm-sub">
                                    <span class="material-symbols-rounded" style="font-size:18px; color:#1A73E8;">${styleInfo.iconName}</span>
                                    <span>${styleInfo.typeLabel}</span>
                                </div>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}" target="_blank" class="gm-btn">
                                    <span class="material-symbols-rounded" style="font-size:18px; color:white;">directions</span>
                                    <span>Prowadź do celu</span>
                                </a>
                            </div>
                        `;
                        marker.bindPopup(content);
                        marker.addTo(markersGroup);

                        allMarkers.push({ 
                            name: safeName, 
                            layer: marker,
                            typeLabel: styleInfo.typeLabel,
                            iconName: styleInfo.iconName,
                            isPath: false,
                            isPlot: styleInfo.isPlot 
                        });
                    });
                }
            } catch(e) { console.error(e); }
        }

        // --- 4. WYSZUKIWARKA (Z KLAWIATURĄ I SORTOWANIEM) ---
        const searchInput = document.getElementById('search-input');
        const suggestionsList = document.getElementById('suggestions-list');
        const searchCard = document.getElementById('search-card');
        const closeBtn = document.getElementById('search-btn');
        
        let currentFocus = -1; // Indeks zaznaczonego elementu

        function cleanQuery(query) {
            let q = query.toLowerCase();
            q = q.replace(/^(działka|dzialka|numer|nr|posesja|dom|ogród|rod|ulica|adres)\s+/g, '');
            return q.trim();
        }

        // --- OBSŁUGA KLAWIATURY (STRZAŁKI) ---
        searchInput.addEventListener('keydown', function(e) {
            let items = suggestionsList.getElementsByTagName("li");
            if (e.key === 'ArrowDown') {
                currentFocus++;
                addActive(items);
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                addActive(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocus > -1) {
                    if (items) items[currentFocus].click();
                } else {
                    // Jeśli nic nie wybrano, wybierz pierwszy wynik
                    if (items && items.length > 0) items[0].click();
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("active");
            // Scrollowanie do elementu jeśli lista jest długa
            x[currentFocus].scrollIntoView({ block: 'nearest' });
        }

        function removeActive(x) {
            for (var i = 0; i < x.length; i++) {
                x[i].classList.remove("active");
            }
        }

        // --- LOGIKA WYSZUKIWANIA ---
        searchInput.addEventListener('input', function() {
            const rawValue = this.value;
            const query = cleanQuery(rawValue);
            
            closeBtn.style.display = rawValue.length > 0 ? 'flex' : 'none';
            currentFocus = -1; // Reset wyboru klawiaturą

            if (query.length < 1) { hideSuggestions(); return; }

            // Filtrowanie
            let matches = allMarkers.filter(m => {
                const nameMatch = m.name.toLowerCase().includes(query);
                const typeMatch = m.typeLabel.toLowerCase().includes(query);
                return nameMatch || typeMatch;
            });

            // --- SORTOWANIE (Priorytety) ---
            matches.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                const q = query;

                // 1. Dokładne dopasowanie nazwy (np. "3")
                if (aName === q && bName !== q) return -1;
                if (aName !== q && bName === q) return 1;

                // 2. Działki wyżej niż inne punkty
                if (a.isPlot && !b.isPlot) return -1;
                if (!a.isPlot && b.isPlot) return 1;

                // 3. Sortowanie numeryczne
                return aName.localeCompare(bName, undefined, {numeric: true, sensitivity: 'base'});
            });

            matches = matches.slice(0, 5);

            if (matches.length > 0) showSuggestions(matches);
            else hideSuggestions();
        });

        function showSuggestions(matches) {
            suggestionsList.innerHTML = '';
            matches.forEach(m => {
                const li = document.createElement('li');
                li.className = `suggestion-item ${m.isPlot ? 'is-plot' : ''}`;
                li.innerHTML = `
                    <span class="material-symbols-rounded suggestion-icon">${m.iconName}</span>
                    <span>${m.name}</span>
                    <span class="suggestion-sub">${m.typeLabel}</span>
                `;
                li.onclick = () => selectResult(m);
                suggestionsList.appendChild(li);
            });
            suggestionsList.style.display = 'block';
            searchCard.classList.add('open');
        }

        function hideSuggestions() {
            suggestionsList.style.display = 'none';
            searchCard.classList.remove('open');
            currentFocus = -1;
        }

        function selectResult(item) {
            searchInput.value = item.name;
            hideSuggestions();
            if (item.isPath) {
                map.fitBounds(item.layer.getBounds(), { padding: [50, 50] });
                item.layer.openPopup();
            } else {
                map.flyTo(item.layer.getLatLng(), 19, { duration: 1.5 });
                setTimeout(() => item.layer.openPopup(), 1500);
            }
        }

        function clearSearch() {
            searchInput.value = '';
            hideSuggestions();
            closeBtn.style.display = 'none';
        }

        document.getElementById('locate-me').onclick = () => {
            map.locate({setView: true, maxZoom: 18});
        };

        map.on('locationfound', (e) => {
            map.eachLayer(l => { if(l._isUser) map.removeLayer(l); });
            L.circleMarker(e.latlng, { radius: 10, fillColor: '#4285F4', color: 'white', weight: 3, fillOpacity: 1 }).addTo(map)._isUser = true;
            L.circle(e.latlng, { radius: e.accuracy, fillColor: '#4285F4', fillOpacity: 0.15, stroke: false }).addTo(map)._isUser = true;
        });

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        loadData();

    </script>
</body>
</html>